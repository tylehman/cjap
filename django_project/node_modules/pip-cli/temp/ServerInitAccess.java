package com.pip.servlet;

import org.apache.log4j.Logger;

import com.pip.accountcloud.api.AccountServer;
import com.pip.common.model.Result;
import com.pip.common.sys.SimpleLog;
import com.pip.common.version.Version;
import com.pip.util.ServiceLocator;

public class ServerInitAccess
{
    private static Logger LOG = Logger.getLogger(ServerInitAccess.class);
    
    private static boolean isPrinted = false;
    
    public void ini()
    {
        if (!isPrinted)
        {
            Thread t = new Thread(new Runnable()
            {
                @Override
                public void run()
                {
                    boolean inifailed = false;
                    try
                    {
                        Thread.sleep(5000);
                    }
                    catch (InterruptedException e)
                    {
                        e.printStackTrace();
                    }
                    
                    LOG.debug("==========================================");
                    LOG.debug(">>>>>>>> 各服务初始化访问");
                    
                    AccountServer accountServer = null;
                    try
                    {
                        accountServer = (AccountServer)ServiceLocator.findService("accountServer");
                    }
                    catch (Exception e)
                    {
                        accountServer = null;
                        inifailed = true;
                        SimpleLog.outException(null, "获取帐号服务异常", e);
                    }
                    
                    if (!inifailed)
                    {
                        Result<String> r;
                        try
                        {
                            r = accountServer.getVersion();
                            String version = (String)r.getResult();
                            if (!Version.version.equals(version))
                            {
                                inifailed = true;
                            }
                        }
                        catch (Exception e)
                        {
                            inifailed = true;
                        }
                    }
                    
                    if (inifailed)
                    {
                        SimpleLog.outString("服务版本不一致或依赖的服务不可用, web启动失败！！！！！！！！！！！！！！！！！");
                        ServiceLocator.destroy();
                    }
                    LOG.debug(">>>>>>>> 各服务初始化访问完成!");
                    LOG.debug("==========================================");
                    isPrinted = true;
                }
                
            });
            t.start();
        }
    }
}
